<html>
<head>
  <title>Remora Interactive</title>

  <link rel="stylesheet" href="libs/bootstrap-1.4.0/bootstrap.min.css">

  <style>
    textarea {
      width: 100%;
      height: 200px;
      margin-bottom: 18px;
    }

    pre {
      overflow: auto;
      height: 300px;
    }

    .alert-message {
      display: none;
    }

    .render-ok {
      display: none;
    }

    .tabs {
      margin-bottom: 10px;
    }

    #displayed {
      height: 300px;
      border: 1px solid rgba(0, 0, 0, 0.15);
      border-radius: 3px 3px 3px 3px;
      font-size: 12px;
      line-height: 18px;
      margin: 0 0 18px;
      padding: 8.5px;
      word-wrap: break-word;
    }

  </style>

</head>

<body>
<div class="container">
  <div class="row">
    <h1>Remora Interactive</h1>

    <div class="span8">
      <h2>1. Write a Template</h2>
      <textarea id="templateTxt"></textarea>

      <div class="parse-error alert-message warning"></div>
      <ul class="parse-ok tabs" data-tabs="tabs">
        <li class="active"><a href="#ast">Parse tree</a></li>
        <li><a href="#javascript">Generated JavaScript</a></li>
      </ul>
      <div class="parse-ok tab-content">
        <div class="active" id="ast"><pre></pre></div>
        <div id="javascript"><pre></pre></div>
      </div>

    </div>

    <div class="span8">
      <h2>2. Give it some data</h2>
      <textarea id="dataTxt"></textarea>

      <div class="render-error alert-message warning"></div>
      <ul class="render-ok tabs" data-tabs="tabs">
        <li class="active"><a href="#rendered">Rendered</a></li>
        <li><a href="#displayed">Displayed</a></li>
      </ul>
      <div class="render-ok tab-content">
        <div class="active" id="rendered"><pre></pre></div>
        <div id="displayed"></div>
      </div>

    </div>

  </div>
</div>

<script src="libs/jquery-1.7.1.min.js"></script>
<script src="libs/bootstrap-1.4.0/bootstrap-tabs.js"></script>
<script data-main="../" src="../libs/require-1.0.2/require.js"></script>

<script>
  function log() {
    console.log.apply(console, arguments);
  }

  requirejs.config({
    urlArgs: "?_cachebuster=" + (+new Date()),
    paths: {
      "text": "libs/require-1.0.2/text",
      "underscore": "libs/underscore-1.2.3",
      "PEG": "libs/peg-0.6.2-amd",
      "remora/parser": "remora/parser.debug"
    }
  });

  $("#templateTxt").text([
    "<p>Hello, ${name}!</p>",
    "% if friends.length > 0:",
    "  <ul>",
    "  % for friend in friends:",
    "    <li>${friend.name}</li>",
    "  % endfor",
    "  </ul>",
    "% else:",
    "  <p>I'm sorry... You don't appear to have any friends.</p>",
    "  <p>Can I be your friend?</p>",
    "% endif"
  ].join("\n") + "\n");

  $("#dataTxt").text([
    "return {",
    "  name: 'wolever',",
    "  friends: [",
    "    { name: 'Andrey' },",
    "    { name: 'Alex' }",
    "  ]",
    "};"
  ].join("\n") + "\n");

  var template = null;

  require(["underscore", "remora/remora", "remora/evaler", "./libs/jsDump-modified.js"],
  function(_, remora, evaler) {
    window._ = _;
    window.remora = remora;
    window.evaler = evaler;

    function showError(selector, e) {
      $(selector)
        .show()
        .text(e.message);
    }

    function onChange(elem, func) {
      var lastVal = undefined;
      function check() {
        var curVal = elem.val();
        if (lastVal != curVal) {
          func(curVal);
          lastVal = curVal;
        }
      }
      check();
      setInterval(check, 200);
    };

    function reRender() {
      $(".render-ok, .render-error").hide();
      if (!template)
        return;
      
      var data;
      try {
        var js = "(function() {" + $("#dataTxt").val() + "})";
        data = eval(js)();
      } catch (e) {
        showError(".render-error", e);
        return;
      };

      var rendered;
      try {
        rendered = template.render(data);
      } catch (e) {
        showError(".render-error", e);
        return;
      }

      $(".render-ok").show();
      $("#rendered pre").text(rendered);
      $("#displayed").html(rendered);
    };

    onChange($("#templateTxt"), function(text) {
      $(".parse-ok, .parse-error").hide();

      try {
        template = remora.Template(text);
      } catch (e) {
        template = null;
        window.e = e;
        showError(".parse-error", e);
        return;
      }

      $(".parse-ok").show();
      $("#ast pre").text(jsDump.parse(template._parsed));
      $("#javascript pre").text(template._js.source);
      reRender();
    });

    onChange($("#dataTxt"), reRender);
  });

</script>

</body>
</html>
